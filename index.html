<!DOCTYPE html>
<html>
	<!--
    	作者：954316227@qq.com
    	时间：2017-10-29
    	描述：
    -->
	<head>
		<meta charset="UTF-8">
		<script type="text/javascript" src="js/hotcss.js"></script>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>首页</title>
		<script src="js/mui.min.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/home.css" />
		<script src="js/jquery.js" type="text/javascript" charset="utf-8"></script>

		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.mui-title {
				color: whitesmoke;
			}
			
			.mui-bar-tab .mui-tab-item.mui-active {
				color: #FE434C;
				/* 这里放你想要的颜色 */
			}
			
			.mui-bar .mui-icon:active {
				opacity: 1;
			}
			
			.mui-wraps {
				position: relative;
				bottom: 40px;
			}
			
			.mui-content {
				padding-top: 40px;
			}
		</style>
	</head>

	<body>
		
		<!--<header class="mui-bar mui-bar-nav">
		    <h1 class="mui-title">首页</h1>
		</header>-->
		
		<nav class="mui-bar mui-bar-tab">
		    <a class="mui-tab-item mui-active">
		        <span class="mui-icon "><img src="imgs/index/sy.png"/></span>
		        <span class="mui-tab-label">首页</span>
		    </a>
		    <a class="mui-tab-item">
		        <span class="mui-icon"><img src="imgs/index/fln.png"/></span>
		        <span class="mui-tab-label">分类</span>
		    </a>
		    <a class="mui-tab-item">
		        <span class="mui-icon"><img src="imgs/index/gwcn.png"/></span>
		        <span class="mui-tab-label">购物车</span>
		    </a>
		    <a class="mui-tab-item">
		        <span class="mui-icon"><img src="imgs/index/dmdn.png"/></span>
		        <span class="mui-tab-label">地面店</span>
		    </a>
		    <a class="mui-tab-item">
		        <span class="mui-icon"><img src="imgs/index/wdn.png"/></span>
		        <span class="mui-tab-label">我的</span>
		    </a>
		    
		    
		    
		</nav>
		
		<div class="mui-content mui-wraps">

			<div id="slider" class="">
				<div id="sliderSegmentedControl" class="mui-segmented-control mui-segmented-control-inverted bg-w">

				</div>
				<div class="mui-slider-group" style="margin-bottom: 2rem;">
				</div>
			</div>
		</div>


		<script src="js/util.js"></script>
		<script src="js/home.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var aniShow = {};
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			
			
			
			
			$('.mui-tab-item').on("tap",function(e){
				
//				console.log($(e.currentTarget).index());
//				console.log($(e.target)[0].innerText);
				if($(e.currentTarget).index() == 1){
					mui.openWindow({
						url : "./html/classify.html" ,
						id : "classify"
					});
				}
//				console.log($(e.currentTarget).children(".mui-tab-label").text());
			});
			
			
			
			
			
			var menuUrl = "http://47.94.84.71/mallApp-1.0/app/menu/selectMenu1?jsoncallback=?";
			mui.ajax(menuUrl, {
				type: "get",
				dataType: "json",
				jsonp: "jsoncallback",
				success: function(data) {
					firstDataFn(data);
				},

				error: function(err) {
					mui.toast("网络请求出错");
				}
			});
			
			function firstDataFn(menuData) {
//				menuData = JSON.parse(menuData);
				for(var i = 0; i < menuData.length; i++) {
					var menuName = menuData[i].menuname;
					var menuId = menuData[i].id;
					var nums = i + 1;
					var hrefs = "#item" + nums + "mobile";
					var itemId = "item" + nums + "mobile";
					var products = "";
					var lunbo = ' <div id="slider" class="mui-slider">' +
						'<div class="mui-slider-group mui-slider-loop">' +
						'<div class="mui-slider-item mui-slider-item-duplicate">' +
						'<a href="#">' +
						'<img src="imgs/home/banner4.png">' +
						'</a>' +
						'</div>' +
						'<div class="mui-slider-item">' +
						'<a href="#">' +
						'<img src="imgs/home/banner4.png">' +
						'</a>' +
						'</div>' +
						'<div class="mui-slider-item">' +
						'<a href="#">' +
						'<img src="imgs/home/banner1.png">' +
						'</a>' +
						'</div>' +
						'<div class="mui-slider-item">' +
						'<a href="#">' +
						'<img src="imgs/home/banner2.png">' +
						'</a>' +
						'</div>' +
						'<div class="mui-slider-item">' +
						'<a href="#">' +
						'<img src="imgs/home/banner-3.png">' +
						'</a>' +
						'</div>' +
						'<div class="mui-slider-item mui-slider-item-duplicate">' +
						'<a href="#">' +
						'<img src="imgs/home/banner4.png">' +
						'</a>' +
						'</div>' +
						'</div>' +
						'<div class="mui-slider-indicator">' +
						'<div class="mui-indicator mui-active"></div>' +
						'<div class="mui-indicator"></div>' +
						'<div class="mui-indicator"></div>' +
						'<div class="mui-indicator"></div>' +
						'</div>' +
						'</div>' +
						'<div class="specially">' +
						'<div class="bg_left"></div>' +
						'<span>特惠</span>' +
						'<div class="bg_right"></div>' +
						'</div>';
					var menuList = ' <a class="mui-control-item" href=' + hrefs + '>' + menuName + '</a>';
					var contentList = '<div id=' + itemId + ' class="others md-f1 mui-slider-item mui-control-content md-box md-ver"> </div>';
					//					$("#sliderSegmentedControl").html("")
					//					$('.mui-slider-group').html("")
					$("#sliderSegmentedControl").append(menuList);
					$('.mui-slider-group').append(contentList);
					if(i == 0) {
						$('#sliderSegmentedControl .mui-control-item').addClass('mui-active');
						$('.mui-slider-group .others').addClass('mui-active');
					}
					menuTap(menuId, hrefs);

				}
				$('.others').append(lunbo);
				var gallery = mui('.mui-slider');
				gallery.slider({
					interval: 1000 //自动轮播周期，若为0则不自动播放，默认为0；
				});

			}
			
			// 顶部选项卡轻拍
			function menuTap(menuId, hrefs) {
				if(false) {
					var sss = localStorage.getItem(__searchStr);
					myPost('/app/product/selectByMenu2', {
						id: localStorage.getItem(__searchStr)
					}, function(data) {

						if(data && data.length > 0) {
							fenleiData(data, hrefs);
						} else {
							mui.toast("查询" + sss + "失败...");
							myPost('/app/product/selectByMenu1', {
								id: menuId
							}, function(data) {
								fenleiData(data, hrefs);
								console.log(data);
							})
						}

					})
					localStorage.setItem(__searchStr, "");
				} else {
					myPost('/app/product/selectByMenu1', {
						id: menuId
					}, function(data) {
						fenleiData(data, hrefs);
						console.log(data);
					})
				}

			}

			function fenleiData(data, hrefs) {
				console.log(data);
				for(var j = 0; j < data.length; j++) {
					var shopId=data[j].productId;
					var productName = data[j].productname;
					var productInfo = data[j].productdepict;
					var productPrice = data[j].price1;
					var productId = data[j].productId;
					var productUrl = homeImageUrl + data[j].imgurl;
					var detailBtn = document.createElement("div");
					detailBtn.href = "#";
					detailBtn.className = "detailBtn";
					//							
					var productList = '<ul class="mui-table-view" id="ul-wraps">' +
						'<li class="mui-table-view-cell mui-media mui-col-xs-6">' +
						'<div href="#" class="detailBtn" shopId="" productId="' + productId + '">' +
						'<img class="m-table-img" src=' + productUrl + '>' +
						'<div class="mui-media-body">' +
						'<div>' + productName + '</div>' +
						'<div>' + productInfo + '</div>' +
						'<div>￥' + productPrice + '</div>' +
						'</div>' +
						'</div>' +
						'</li>' +
						'</ul>';
					$(hrefs).append(productList);
				}
				$('.detailBtn').on("tap", {
					productId: productId
				}, productClick);
			}
			
			function productClick(e , producId){
				
				var proId = $(e.currentTarget).attr("productId");
//				console.log($(e.currentTarget).attr("productId"));
				localStorage.setItem("goodDetailId" , proId);
				
				mui.openWindow({
					url:"./html/detail.html",
					id:"detail"
				});
				
				
				
				
			}
			
			
			
			mui.plusReady(function() {
				var self = plus.webview.currentWebview(),
					nviews = self.getSubNViews(),
					subpages = util.options.subpages,
					leftPos = Math.ceil((window.innerWidth - 60) / 2); // 设置凸起大图标为水平居中

				$(".secondBtn").on("tap", function() {

					//打开新窗口
					plus.webview.open("/html/detail.html", "detail");
					var detail = plus.webview.getWebviewById("detail");
					mui.fire(detail, "sb", {
						name: "zhangsan"
					});

				});
				/**	
				 * drawNativeIconBg 绘制带边框的半圆，
				 * 实现原理：
				 *   id为bg的tag 创建带边框的圆
				 *   id为bg2的tag 创建白色矩形遮住圆下半部分，只显示凸起带边框部分
				 *   注意创建先后顺序，创建越晚的层级越高
				 */
				var drawNativeIconBg = util.drawNative('iconBg', {
					bottom: '5px',
					left: leftPos + 'px',
					width: '60px',
					height: '60px',
					position: 'dock'
				}, [{
					tag: 'rect',
					id: 'bg',
					position: {
						top: '0px',
						left: '0px',
						width: '100%',
						height: '100%'
					},
					rectStyles: {
						color: '#fff',
						radius: '30px',
						borderColor: '#ccc',
						borderWidth: '1px'
					}
				}, {
					tag: 'rect',
					id: 'bg2',
					position: {
						bottom: '0px',
						left: '0px',
						width: '100%',
						height: '45px'
					},
					rectStyles: {
						color: '#fff'
					}
				}]);

				/**
				 * 凸起图标最后创建  浮在最顶层
				 *	id为iconBg的红色背景图
				 * 	id为icon的字体图标
				 * 	
				 */
				var drawNativeIcon = util.drawNative('tabIcon', {
					bottom: '10px',
					left: leftPos + 5 + 'px',
					width: '50px',
					height: '50px',
					position: 'dock' //此种停靠方式表明该控件应浮在窗口最上层，以免被其他窗口遮住
				}, [{
					tag: 'rect',
					id: 'iconBg',
					position: {
						top: '0px',
						left: '0px',
						width: '50px',
						height: '100%'
					},
					rectStyles: {
						color: '#d74b28',
						size: '50px',
						radius: '50%'
					}
				}, {
					tag: 'font',
					id: 'icon',
					text: '\ue600', //此为字体图标Unicode码'\e600'转换为'\ue600'
					position: {
						top: '0px',
						left: '0px',
						width: '50px',
						height: '100%'
					},
					textStyles: {
						fontSrc: '_www/fonts/iconfont.ttf',
						align: 'center',
						color: '#fff',
						size: '30px'
					}
				}]);
				// append 到父webview中
				self.append(drawNativeIconBg);
				self.append(drawNativeIcon);

				//自定义监听图标点击事件
				drawNativeIcon.addEventListener('click', function(e) {
					mui.alert('你点击了图标，你在此可以打开摄像头或者新窗口等自定义点击事件。', '悬浮球点击事件');
					// 重绘字体颜色
					drawNativeIcon.drawText('\ue600', {}, {
						fontSrc: '_www/fonts/iconfont.ttf',
						align: 'center',
						color: '#000',
						size: '30px'
					}, 'icon');
				});

				//创建子webview窗口 并初始化
				util.initSubpage();
				var activePage = plus.webview.currentWebview();

				//给每个view 添加监听点击切换
				for(var i = 0; i < 4; i++) {
					nviews[i].addEventListener('click', clickEvent, false);
				}

				// 自定义 tab 点击事件
				function clickEvent(e) {
					var currId = e.target.id,
						currIndex = parseInt(currId.substr(currId.length - 1, 1) - 1),
						currView = self.getStyle().subNViews[currIndex];

					// 匹配对应tab窗口	
					if(currIndex > 0) {
						targetPage = plus.webview.getWebviewById(subpages[currIndex - 1]);
					} else {
						targetPage = plus.webview.currentWebview();
					}

					if(targetPage == activePage) {
						return;
					}

					if(currIndex !== 3) {
						//底部选项卡切换
						util.toggleNview(currView, currIndex);
						// 子页面切换
						util.changeSubpage(targetPage, activePage);
						//更改当前活跃的页面
						activePage = targetPage;
					} else {
						//第四个tab 打开新窗口
						var newWV = plus.webview.create('html/new-webview.html', 'new');
						newWV.show('slide-in-right', 200);
					}
				}
			});
		</script>
	</body>

</html>